apply from: 'local.gradle'

import java.text.SimpleDateFormat

/* user defined procedures */

task updateReleaseInfo {
    doLast {
        def propFile = new File(projectDir, 'src/main/assets/release.properties')
        Properties props = new Properties()
        props.load(new FileInputStream(propFile))

        def buildNumber = Integer.parseInt(props.getProperty('build_number')) + 1

        def df = new SimpleDateFormat('yyyy-MM-dd HH:mm:ss z')
        df.setTimeZone(TimeZone.getTimeZone('UTC'))
        def buildTime = df.format(new Date())

        props.setProperty('build_number', String.valueOf(buildNumber))
        props.setProperty('build_time', String.valueOf(buildTime))
        props.store(new FileOutputStream(propFile), 'Release properties')

        println(':updateReleaseInfo current build=' + buildNumber)
    }
}

assemble.doLast {
    updateReleaseInfo.execute()
    if (project.hasProperty('upload_path')) {
        copy {
            from new File(projectDir, 'build/outputs/apk/')
            include '*-release.apk'
            into upload_path
        }
    }
}